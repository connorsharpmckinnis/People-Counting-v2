<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Engine</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Detection Engine</h1>
            <p class="subtitle">Provided by the Town of Apex</p>
        </header>

        <!-- Info Section -->
        <div class="info-card">
            <h2>Quick Guide</h2>
            <div class="guide-grid">
                <div class="guide-item">
                    <strong>Basic Image/Video</strong>
                    <p>Standard detection - fast and efficient for many use cases</p>
                </div>
                <div class="guide-item">
                    <strong>Sliced Image/Video</strong>
                    <p>Better for small objects, crowds, or aerial footage</p>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="uploadForm" class="upload-form">
            <h2>Configuration</h2>

            <!-- File Upload -->
            <div class="form-group">
                <label for="fileInput">
                    Select File
                    <span class="tooltip"
                        data-tooltip="Choose an image (.jpg, .png) or video (.mp4) to process">‚ÑπÔ∏è</span>
                </label>
                <input type="file" name="file" id="fileInput" accept="image/*,video/*" required>
            </div>

            <!-- Processing Type -->
            <div class="form-group">
                <label for="typeSelect">
                    Processing Type
                    <span class="tooltip"
                        data-tooltip="Basic: Fast standard detection. Sliced: Better for small objects, uses tiled processing.">‚ÑπÔ∏è</span>
                </label>
                <select name="type" id="typeSelect">
                    <option value="basic">Basic Image</option>
                    <option value="sliced">Sliced Image (Better for small objects)</option>
                    <option value="video">Basic Video</option>
                    <option value="sliced_video">Sliced Video (Better for small objects)</option>
                    <option value="polygon_cross_count">Polygon Crossing (Video)</option>
                    <option value="image_zone_count">Image Zone Counting</option>
                </select>
            </div>

            <!-- Model -->
            <div class="form-group">
                <label for="modelSelect">
                    Model
                    <span class="tooltip" data-tooltip="Larger models are more accurate but slower. Nano is fastest.">
                        ‚ÑπÔ∏è
                    </span>
                </label>

                <select id="modelSelect" class="form-control">
                    <option value="yolo11n.pt">Nano (Fastest)</option>
                    <option value="yolo11s.pt">Small</option>
                    <option value="yolo11m.pt">Medium</option>
                    <option value="yolo11l.pt">Large</option>
                    <option value="yolo11x.pt">Extra Large (Most Accurate)</option>
                    <option value="yolo11n_drone.pt">People Only (Best with Aerial Crowds)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="modelInput">Model file</label>
                <input type="text" name="model" id="modelInput" value="yolo11n.pt" class="form-control">
            </div>

            <!-- Confidence Threshold -->
            <div class="form-group">
                <label for="confInput">
                    Confidence Threshold
                    <span class="tooltip"
                        data-tooltip="Lower (0.1-0.3) = more detections but more false positives. Higher (0.5-0.8) = fewer but more confident detections.">‚ÑπÔ∏è</span>
                </label>
                <input type="number" name="conf_threshold" id="confInput" value="0.35" step="0.01" min="0" max="1">
                <span class="input-hint">Current: <span id="confValue">0.35</span></span>
            </div>

            <!-- Classes to Detect -->
            <div class="form-group">
                <label for="polygonClasses">
                    Classes to Detect (Optional)
                    <span class="tooltip"
                        data-tooltip="Comma-separated COCO class IDs. Example: 0=person, 2=car, 7=truck. Leave blank to detect all classes.">
                        ‚ÑπÔ∏è
                    </span>
                </label>

                <input type="text" id="polygonClasses" name="polygon_classes" placeholder="e.g. 0, 2, 7"
                    style="width: 100%;" />

                <small style="display: block; margin-top: 5px; color: #666;">
                    Enter comma-separated integers (COCO class IDs). Example: <code>0,2</code> counts people and cars.
                </small>
            </div>

            <!-- Sliced Image Settings -->
            <div id="slicedImageSettings" class="advanced-settings" style="display:none;">
                <h3>Slicer Settings</h3>
                <p class="settings-description">Image is divided into overlapping tiles for better small object
                    detection</p>

                <div class="form-group">
                    <label for="imgSliceWidth">
                        Slice Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Smaller slices (128-256) = better for tiny objects but slower. Larger (512-1024) = faster but may miss small details.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_slice_width" id="imgSliceWidth" value="256" min="64" max="2048"
                        step="32">
                </div>

                <div class="form-group">
                    <label for="imgSliceHeight">
                        Slice Height (pixels)
                        <span class="tooltip"
                            data-tooltip="Should typically match slice width for square tiles.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_slice_height" id="imgSliceHeight" value="256" min="64" max="2048"
                        step="32">
                </div>

                <div class="form-group">
                    <label for="imgOverlapWidthRatio">
                        Overlap Width Ratio
                        <span class="tooltip"
                            data-tooltip="How much tiles overlap (0.0-1.0). Higher overlap (0.2-0.3) catches objects at tile edges but is slower.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_overlap_width_ratio" id="imgOverlapWidthRatio" value="0.2" min="0"
                        max="1" step="0.05">
                </div>

                <div class="form-group">
                    <label for="imgOverlapHeightRatio">
                        Overlap Height Ratio
                        <span class="tooltip" data-tooltip="Should typically match overlap width ratio.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_overlap_height_ratio" id="imgOverlapHeightRatio" value="0.2" min="0"
                        max="1" step="0.05">
                </div>
            </div>

            <!-- Sliced Video Settings -->
            <div id="slicedVideoSettings" class="advanced-settings" style="display:none;">
                <h3>Slicer Settings</h3>
                <p class="settings-description">Each frame is divided into overlapping tiles with object tracking across
                    frames</p>

                <div class="form-group">
                    <label for="sliceWidth">
                        Slice Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Larger slices (960+) recommended for video to balance speed and accuracy.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="slice_width" id="sliceWidth" value="960" min="64" max="2048" step="32">
                </div>

                <div class="form-group">
                    <label for="sliceHeight">
                        Slice Height (pixels)
                        <span class="tooltip" data-tooltip="Should typically match slice width.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="slice_height" id="sliceHeight" value="960" min="64" max="2048" step="32">
                </div>

                <div class="form-group">
                    <label for="overlapWidth">
                        Overlap Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Pixel overlap between tiles. 10-20px is usually sufficient for video.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="overlap_width" id="overlapWidth" value="10" min="0" max="200" step="5">
                </div>

                <div class="form-group">
                    <label for="overlapHeight">
                        Overlap Height (pixels)
                        <span class="tooltip" data-tooltip="Should typically match overlap width.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="overlap_height" id="overlapHeight" value="10" min="0" max="200" step="5">
                </div>
            </div>

            <!-- Polygon Cross Count Video Settings -->
            <div id="polygonCrossCountSettings" class="advanced-settings" style="display:none;">
                <h3>Polygon Cross Count Settings</h3>
                <p class="settings-description">Define a polygonal region to count objects crossing it</p>

                <div class="form-group">
                    <label>Draw Region on Frame</label>
                    <div class="canvas-container"
                        style="position: relative; width: 100%; max-width: 800px; margin-bottom: 10px;">
                        <canvas id="regionCanvas"
                            style="width: 100%; border: 1px solid #ccc; display: none; cursor: crosshair;"></canvas>
                        <div id="canvasPlaceholder"
                            style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 6px; color: #666;">
                            Select a video to verify frame dimensions and draw markings
                        </div>
                    </div>
                    <button type="button" id="clearPointsBtn"
                        style="padding: 5px 10px; font-size: 0.8rem; background: #636e72; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear
                        Points</button>
                    <small style="display: block; margin-top: 5px; color: #666;">Points: <span
                            id="pointCount">0</span></small>
                </div>

                <div class="form-group">
                    <label for="regionPoints">
                        Region Points (Line or Polygon)
                        <span class="tooltip"
                            data-tooltip="Format: [(x1,y1), (x2,y2)] or [(x1,y1), ..., (x4,y4)]. Default is a vertical line.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="region_points" id="regionPoints" placeholder="[(300, 100), (300, 1200)]"
                        readonly style="background: #f9f9f9; cursor: not-allowed;">
                </div>
            </div>

            <!-- Image Zone Counting Settings -->
            <div id="imageZoneSettings" class="advanced-settings" style="display:none;">
                <h3>Image Zone Settings</h3>
                <p class="settings-description">Draw a polygon zone on the image to count objects within it.</p>

                <div class="form-group">
                    <label>Draw Zone on Image</label>
                    <div class="canvas-container"
                        style="position: relative; width: 100%; max-width: 800px; margin-bottom: 10px;">
                        <canvas id="imgZoneCanvas"
                            style="width: 100%; border: 1px solid #ccc; display: none; cursor: crosshair;"></canvas>
                        <div id="imgZonePlaceholder"
                            style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 6px; color: #666;">
                            Select an image to draw zone
                        </div>
                    </div>
                    <button type="button" id="imgZoneClearBtn"
                        style="padding: 5px 10px; font-size: 0.8rem; background: #636e72; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear
                        Points</button>
                    <small style="display: block; margin-top: 5px; color: #666;">Points: <span
                            id="imgZonePointCount">0</span></small>
                </div>

                <div class="form-group">
                    <label for="imgZonePoints">
                        Zone Points
                        <span class="tooltip"
                            data-tooltip="Format: [(x1,y1), (x2,y2), ...]. Defines the polygon zone.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="img_zone_points" id="imgZonePoints"
                        placeholder="[(50, 50), (250, 50), ...]" readonly
                        style="background: #f9f9f9; cursor: not-allowed;">
                </div>
            </div>

            <button type="submit" class="submit-btn">
                <span id="btnText">üöÄ Upload & Process</span>
                <span id="btnLoader" class="loader" style="display:none;"></span>
            </button>
        </form>



        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display:none;">
            <h2>Results</h2>
            <div class="results-grid">
                <div class="results-card">
                    <h3>Object Counts</h3>
                    <pre id="results"></pre>
                </div>
                <div class="results-card">
                    <h3>Annotated Output</h3>
                    <img id="annotatedImage" style="display:none;">
                    <video id="annotatedVideo" controls style="display:none;"></video>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/script.js"></script>
</body>

</html>