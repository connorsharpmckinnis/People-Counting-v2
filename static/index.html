<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Engine</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Detection Engine</h1>
            <p class="subtitle">Provided by the Town of Apex</p>
            <div style="margin-top: 15px;">
                <a href="/guide"
                    style="display: inline-block; background-color: white; color: #2d3436; text-decoration: none; font-weight: 600; padding: 8px 16px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1.3rem;">
                    üìö How-To Guide
                </a>
            </div>
        </header>

        <!-- Main Form -->
        <form id="uploadForm" class="upload-form">
            <h2>Configuration</h2>

            <!-- File Upload -->
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <span class="drop-zone-icon">üìÅ</span>
                    <span class="drop-zone-text">Click to upload or drag & drop</span>
                    <span class="drop-zone-hint">Supports Images (.jpg, .png) and Videos (.mp4, .mov)</span>
                </div>
                <input type="file" name="file" id="fileInput" accept="image/*,video/*" required class="drop-zone-input">
            </div>
            <div id="filePreview" class="file-preview" style="display:none;">
                <div class="preview-info">
                    <span id="previewName"></span>
                    <button type="button" id="removeFileBtn" class="remove-btn">&times;</button>
                </div>
            </div>

            <!-- Processing Type -->
            <div class="form-group">
                <label for="typeSelect">
                    Processing Type
                    <span class="tooltip"
                        data-tooltip="Basic: Fast standard detection. Sliced: Better for small objects, uses tiled processing.">‚ÑπÔ∏è</span>
                </label>
                <select name="type" id="typeSelect">
                    <optgroup label="üñºÔ∏è Images" id="imageGroup">
                        <option value="basic">Basic Image</option>
                        <option value="sliced">Sliced Image (Better for small objects)</option>
                        <option value="image_zone_count">Image Zone Counting</option>
                        <option value="image_custom">Advanced Image (Custom Classes)</option>
                    </optgroup>
                    <optgroup label="üé• Videos" id="videoGroup">
                        <option value="video">Basic Video</option>
                        <option value="sliced_video">Sliced Video (Better for small objects)</option>
                        <option value="polygon_cross_count">Polygon Crossing</option>
                        <option value="video_custom">Advanced Video (Custom Classes)</option>
                        <option value="stream">YouTube Livestream (Real-time)</option>
                    </optgroup>
                </select>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- Model Select -->
                <div class="form-group" style="flex: 1; min-width: 250px;">
                    <label for="modelSelect">
                        Model
                        <span class="tooltip"
                            data-tooltip="Larger models are more accurate but slower. Nano is fastest.">
                            ‚ÑπÔ∏è
                        </span>
                    </label>

                    <select id="modelSelect" class="form-control">
                        <option value="yolo11n.pt">Nano (Fastest)</option>
                        <option value="yolo11s.pt">Small</option>
                        <option value="yolo11m.pt">Medium</option>
                        <option value="yolo11l.pt">Large</option>
                        <option value="yolo11x.pt">Extra Large (Most Accurate)</option>
                        <option value="yolo11n_drone.pt">Aerial Nano (best for aerials and crowds)</option>
                        <option value="yoloe-11s-seg.pt">YOLOE (Custom Classes)</option>
                    </select>
                </div>

                <!-- Model Input -->
                <div class="form-group" style="flex: 1; min-width: 250px;">
                    <label for="modelInput">Model file</label>
                    <input type="text" name="model" id="modelInput" value="yolo11n.pt" class="form-control">
                </div>
            </div>

            <!-- Confidence Threshold -->
            <div class="form-group">
                <label for="confInput">
                    Confidence Threshold
                    <span class="tooltip"
                        data-tooltip="Lower (0.1-0.3) = more detections but more false positives. Higher (0.5-0.8) = fewer but more confident detections.">‚ÑπÔ∏è</span>
                </label>
                <input type="number" name="conf_threshold" id="confInput" value="0.35" step="0.01" min="0" max="1">
            </div>

            <!-- Standard Classes to Detect -->
            <div class="form-group" id="standardClassesGroup">
                <label for="polygonClasses">
                    Classes to Detect (Optional)
                    <span class="tooltip"
                        data-tooltip="Comma-separated COCO class IDs. Example: 0=person, 2=car, 7=truck. Leave blank to detect all classes.">
                        ‚ÑπÔ∏è
                    </span>
                </label>

                <input type="text" id="polygonClasses" name="polygon_classes" placeholder="e.g. 0, 2, 7"
                    style="width: 100%;" />

                <small style="display: block; margin-top: 5px; color: #666;">
                    Enter comma-separated COCO class IDs. Example: <code>0,2</code> counts only people and cars.
                </small>
            </div>

            <!-- Custom Classes to Detect -->
            <div class="form-group" id="customClassesGroup" style="display:none;">
                <label for="customClassesInput">
                    Custom Class Names (Required)
                    <span class="tooltip"
                        data-tooltip="Enter ANY object names you want to detect, separated by commas.">
                        ‚ÑπÔ∏è
                    </span>
                </label>

                <input type="text" id="customClassesInput" name="custom_classes"
                    placeholder="e.g. person, backpack, red hat" style="width: 100%;" />

                <small style="display: block; margin-top: 5px; color: #666;">
                    Enter comma-separated names of objects. Example: <code>person, red car, dog</code>.
                </small>
            </div>

            <!-- Sliced Image Settings -->
            <div id="slicedImageSettings" class="advanced-settings" style="display:none;">
                <h3>Slicer Settings</h3>
                <p class="settings-description">Image is divided into overlapping tiles for better small object
                    detection</p>

                <div class="form-group">
                    <label for="imgSliceWidth">
                        Slice Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Smaller slices (128-256) = better for tiny objects but slower. Larger (512-1024) = faster but may miss small details.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_slice_width" id="imgSliceWidth" value="256" min="64" max="2048"
                        step="32">
                </div>

                <div class="form-group">
                    <label for="imgSliceHeight">
                        Slice Height (pixels)
                        <span class="tooltip"
                            data-tooltip="Should typically match slice width for square tiles.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_slice_height" id="imgSliceHeight" value="256" min="64" max="2048"
                        step="32">
                </div>

                <div class="form-group">
                    <label for="imgOverlapWidthRatio">
                        Overlap Width Ratio
                        <span class="tooltip"
                            data-tooltip="How much tiles overlap (0.0-1.0). Higher overlap (0.2-0.3) catches objects at tile edges but is slower.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_overlap_width_ratio" id="imgOverlapWidthRatio" value="0.2" min="0"
                        max="1" step="0.05">
                </div>

                <div class="form-group">
                    <label for="imgOverlapHeightRatio">
                        Overlap Height Ratio
                        <span class="tooltip" data-tooltip="Should typically match overlap width ratio.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="img_overlap_height_ratio" id="imgOverlapHeightRatio" value="0.2" min="0"
                        max="1" step="0.05">
                </div>
            </div>

            <!-- Sliced Video Settings -->
            <div id="slicedVideoSettings" class="advanced-settings" style="display:none;">
                <h3>Slicer Settings</h3>
                <p class="settings-description">Each frame is divided into overlapping tiles with object tracking across
                    frames</p>

                <div class="form-group">
                    <label for="sliceWidth">
                        Slice Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Larger slices (960+) recommended for video to balance speed and accuracy.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="slice_width" id="sliceWidth" value="960" min="64" max="2048" step="32">
                </div>

                <div class="form-group">
                    <label for="sliceHeight">
                        Slice Height (pixels)
                        <span class="tooltip" data-tooltip="Should typically match slice width.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="slice_height" id="sliceHeight" value="960" min="64" max="2048" step="32">
                </div>

                <div class="form-group">
                    <label for="overlapWidth">
                        Overlap Width (pixels)
                        <span class="tooltip"
                            data-tooltip="Pixel overlap between tiles. 10-20px is usually sufficient for video.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="overlap_width" id="overlapWidth" value="10" min="0" max="200" step="5">
                </div>

                <div class="form-group">
                    <label for="overlapHeight">
                        Overlap Height (pixels)
                        <span class="tooltip" data-tooltip="Should typically match overlap width.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="overlap_height" id="overlapHeight" value="10" min="0" max="200" step="5">
                </div>
            </div>

            <!-- Polygon Cross Count Video Settings -->
            <div id="polygonCrossCountSettings" class="advanced-settings" style="display:none;">
                <h3>Polygon Cross Count Settings</h3>
                <p class="settings-description">Define polygonal regions or lines to count objects crossing them</p>

                <!-- Instructions Callout -->
                <div
                    style="background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="font-size: 1.1em;">üìù Drawing Instructions:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Click</strong> to add points to your current polygon/line</li>
                        <li>Click <strong>"Finish & Start New"</strong> to complete the current shape and begin another
                        </li>
                        <li>Draw <strong>2 points</strong> for a line, or <strong>3+ points</strong> for a polygon</li>
                        <li>Each region will be shown in a <strong>different color</strong></li>
                    </ul>
                </div>

                <div class="form-group">
                    <label>Draw Regions on Frame</label>
                    <div class="canvas-container"
                        style="position: relative; width: 100%; max-width: 800px; margin-bottom: 10px;">
                        <canvas id="regionCanvas"
                            style="width: 100%; border: 1px solid #ccc; display: none; cursor: crosshair;"></canvas>
                        <div id="canvasPlaceholder"
                            style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 6px; color: #666;">
                            Select a video to verify frame dimensions and draw markings
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
                        <button type="button" id="finishVideoRegionBtn"
                            style="padding: 8px 16px; font-size: 0.9rem; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            ‚úì Finish & Start New Region
                        </button>
                        <button type="button" id="clearPointsBtn"
                            style="padding: 8px 16px; font-size: 0.9rem; background: #636e72; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è Clear All Regions
                        </button>
                    </div>
                    <small style="display: block; color: #666;">
                        <span id="pointCount">0 pts / 0 complete</span> ‚Äî
                        <em>Dashed lines = in-progress, solid = complete</em>
                    </small>
                </div>

                <div class="form-group">
                    <label for="regionPoints">
                        Region Points (Line or Polygon)
                        <span class="tooltip"
                            data-tooltip="Single region: [(x1,y1), ...]. Multiple regions: {'region-01': [...], 'region-02': [...]}">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="region_points" id="regionPoints" placeholder="[(300, 100), (300, 1200)]"
                        readonly style="background: #f9f9f9; cursor: not-allowed;">
                </div>
            </div>

            <!-- Image Zone Counting Settings -->
            <div id="imageZoneSettings" class="advanced-settings" style="display:none;">
                <h3>Image Zone Settings</h3>
                <p class="settings-description">Draw polygon zones on the image to count objects within them.</p>

                <!-- Instructions Callout -->
                <div
                    style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="font-size: 1.1em;">üìù Drawing Instructions:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Click</strong> to add points to your current polygon</li>
                        <li>Click <strong>"Finish & Start New"</strong> to complete the current zone and begin another
                        </li>
                        <li>Draw <strong>3+ points</strong> to create a polygon zone</li>
                        <li>Each zone will be shown in a <strong>different color</strong></li>
                    </ul>
                </div>

                <div class="form-group">
                    <label>Draw Zones on Image</label>
                    <div class="canvas-container"
                        style="position: relative; width: 100%; max-width: 800px; margin-bottom: 10px;">
                        <canvas id="imgZoneCanvas"
                            style="width: 100%; border: 1px solid #ccc; display: none; cursor: crosshair;"></canvas>
                        <div id="imgZonePlaceholder"
                            style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 6px; color: #666;">
                            Select an image to draw zones
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
                        <button type="button" id="finishImageZoneBtn"
                            style="padding: 8px 16px; font-size: 0.9rem; background: #6c5ce7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            ‚úì Finish & Start New Zone
                        </button>
                        <button type="button" id="imgZoneClearBtn"
                            style="padding: 8px 16px; font-size: 0.9rem; background: #636e72; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è Clear All Zones
                        </button>
                    </div>
                    <small style="display: block; color: #666;">
                        <span id="imgZonePointCount">0 pts / 0 complete</span> ‚Äî
                        <em>Dashed lines = in-progress, solid = complete</em>
                    </small>
                </div>

                <div class="form-group">
                    <label for="imgZonePoints">
                        Zone Points
                        <span class="tooltip"
                            data-tooltip="Single zone: [(x1,y1), ...]. Multiple zones: {'region-01': [...], 'region-02': [...]}">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="img_zone_points" id="imgZonePoints"
                        placeholder="[(50, 50), (250, 50), ...]" readonly
                        style="background: #f9f9f9; cursor: not-allowed;">
                </div>
            </div>

            <!-- Livestream Settings -->
            <div id="livestreamSettings" class="advanced-settings" style="display:none;">
                <h3>Livestream Settings</h3>
                <p class="settings-description">Process a live YouTube stream for a set duration</p>

                <div class="form-group">
                    <label for="streamUrl">
                        YouTube URL
                        <span class="tooltip" data-tooltip="The full URL to the YouTube livestream.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="youtube_url" id="streamUrl"
                        placeholder="https://www.youtube.com/watch?v=..." class="form-control">
                </div>

                <div class="form-group">
                    <label for="streamDuration">
                        Capture Duration (seconds)
                        <span class="tooltip"
                            data-tooltip="How long to analyze the stream. 30-300 seconds is usually good for a sample.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="duration" id="streamDuration" value="30" min="5" max="1800">
                </div>

                <div class="form-group">
                    <label for="streamFrameSkip">
                        Frame Skip
                        <span class="tooltip"
                            data-tooltip="Sample every Nth frame. Higher = faster, Lower = more smooth tracking.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" name="frame_skip" id="streamFrameSkip" value="5" min="1" max="60">
                </div>
            </div>

            <!-- Complexity Estimation -->
            <div id="estimationSection" class="info-card"
                style="display:none; margin-top: 1.5rem; border-left: 5px solid var(--warning-color);">
                <h3 style="color: var(--text-primary); margin-bottom: 10px;">Processing Estimate</h3>
                <div class="results-grid"
                    style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <strong
                            style="display:block; color:var(--text-secondary); font-size: 0.9rem;">Resolution</strong>
                        <span id="estRes" style="font-weight:600; font-size:1.1rem;">-</span>
                    </div>
                    <div>
                        <strong style="display:block; color:var(--text-secondary); font-size: 0.9rem;">Total
                            Frames</strong>
                        <span id="estFrames" style="font-weight:600; font-size:1.1rem;">-</span>
                    </div>
                    <div>
                        <strong style="display:block; color:var(--text-secondary); font-size: 0.9rem;">Slices /
                            Frame</strong>
                        <span id="estSlices" style="font-weight:600; font-size:1.1rem;">-</span>
                    </div>
                    <div>
                        <strong style="display:block; color:var(--text-secondary); font-size: 0.9rem;">Total
                            Inferences</strong>
                        <span id="estTotal"
                            style="font-weight:600; font-size:1.1rem; color: var(--primary-color);">-</span>
                    </div>
                </div>
                <div id="estDuration"
                    style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary); font-style: italic;">
                </div>
                <div id="estWarning" style="margin-top: 10px; font-weight: 600; font-size: 0.9rem; display:none;"></div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="btnText">Upload & Process</span>
                <span id="btnLoader" class="loader" style="display:none;"></span>
            </button>
        </form>



        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display:none;">
            <h2>Results</h2>
            <div class="results-grid">
                <div class="results-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">Object Counts</h3>
                        <button type="button" id="copyResultsBtn" class="btn"
                            style="padding: 4px 12px; font-size: 0.8rem; background: var(--secondary-color); border-radius: 4px;">üìã
                            Copy</button>
                    </div>
                    <pre id="results"></pre>
                </div>
                <div class="results-card">
                    <h3>Annotated Output</h3>
                    <img id="annotatedImage" style="display:none;">
                    <video id="annotatedVideo" controls style="display:none;"></video>

                    <a id="downloadResultBtn" href="#" class="btn btn-primary" download
                        style="display:none; width: 100%; margin-top: 15px; text-align: center;">
                        ‚¨áÔ∏è Download Result
                    </a>
                </div>
            </div>
        </div>

        <!-- Bug Report Section -->
        <div class="bug-report-section"
            style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
            <h2>Report a Bug</h2>
            <p style="margin-bottom: 15px; color: #555;">Encountered an issue? Please click the button below to send me
                a report. The more descriptive, the better.</p>
            <a href="mailto:connor.mckinnis@apexnc.org?subject=Detection%20Engine%20Bug%20Report"
                class="btn btn-danger">
                Report Bug
            </a>
        </div>

        <!-- About Section -->
        <div class="about-section"
            style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
            <h2>About This System</h2>
            <p style="margin-bottom: 15px; color: #555;">This system is being developed by Connor McKinnis with the Town
                of Apex's IT Innovations division.</p>
            <p style="margin-bottom: 15px; color: #555;">It is provided as-is for regional partners to access basic
                computer vision tools without requiring in-house expertise.</p>
            <a href="mailto:connor.mckinnis@apexnc.org?subject=Detection%20Engine" class="btn btn-primary"
                style="margin-top: 15px;">
                Contact Me
            </a>
        </div>

        <!-- Disclaimers -->
        <footer
            style="text-align: center; color: rgba(255,255,255,0.7); margin-top: 4rem; padding-bottom: 4rem; font-size: 0.9rem;">
            <p>Detection Engine is an evolving tool. Always validate AI-generated statistics for critical operational
                needs.</p>
            <p style="margin-top: 10px;">&copy; 2024 Town of Apex Detection Engine</p>
        </footer>

    </div>


    <script src="/static/script.js"></script>
</body>

</html>